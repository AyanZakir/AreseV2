<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arese OS v2.5 Architect</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
    
    <style>
        /* CORE VARIABLES */
        :root { 
            --blue: #00d2ff; 
            --bg: #0b0b0b; 
            --glass: rgba(255,255,255,0.08); 
            --border: #1f1f1f;
        }

        /* RESET & VIEWPORT FIX [No Glitch] */
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { 
            margin: 0; padding: 0; 
            background: var(--bg); color: #fff; 
            width: 100vw; height: 100dvh; /* Mobile Fix */
            overflow: hidden; 
            display: flex; 
        }

        /* --- SIDEBAR HISTORY --- */
        #sidebar { 
            width: 280px; 
            background: #080808; 
            border-right: 1px solid var(--border); 
            position: fixed; 
            left: -280px; 
            height: 100%; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 2000; 
            padding: 20px; 
            display: flex; flex-direction: column; 
        }
        #sidebar.open { left: 0; box-shadow: 50px 0 100px rgba(0,0,0,0.8); }
        
        .new-chat-btn {
            width: 100%; padding: 12px; 
            background: var(--blue); color: #000; 
            border: none; border-radius: 12px; 
            font-weight: 800; cursor: pointer; 
            margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .hist-item { 
            padding: 14px; 
            background: #111; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            margin-bottom: 8px; 
            font-size: 13px; 
            display: flex; justify-content: space-between; align-items: center;
            color: #ccc; cursor: pointer;
        }
        .hist-item:active { background: #222; }

        /* --- MAIN LAYOUT --- */
        #app { 
            flex: 1; display: flex; flex-direction: column; 
            height: 100%; width: 100%; position: relative; 
        }

        #header { 
            padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(8,8,8,0.95); 
            border-bottom: 1px solid var(--border); 
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        /* --- CHAT AREA --- */
        #chat-flow { 
            flex: 1; overflow-y: auto; 
            padding: 20px; 
            display: flex; flex-direction: column; gap: 25px; 
            scroll-behavior: smooth;
        }
        
        .msg-container { display: flex; width: 100%; gap: 12px; align-items: flex-start; }
        .user-side { justify-content: flex-end; }
        .ai-side { justify-content: flex-start; }

        /* AVATAR LOADING RING */
        .ai-avatar { position: relative; width: 36px; height: 36px; flex-shrink: 0; margin-top: 2px; }
        .msg-logo { width: 100%; height: 100%; border-radius: 50%; border: 1px solid #333; }
        .ring { 
            position: absolute; top: -2px; left: -2px;
            width: calc(100% + 4px); height: calc(100% + 4px); 
            border: 2px solid transparent; 
            border-top: 2px solid var(--blue); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            display: none; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* BUBBLES */
        .msg { 
            max-width: 85%; 
            padding: 12px 16px; 
            border-radius: 20px; 
            font-size: 15px; 
            line-height: 1.5; 
            position: relative; 
            word-wrap: break-word;
        }
        .ai { 
            background: var(--glass); 
            border: 1px solid rgba(0,210,255,0.3); 
            color: var(--blue); 
            border-top-left-radius: 4px; 
        }
        .user { 
            background: #222; 
            border: 1px solid #333; 
            color: #fff;
            border-top-right-radius: 4px; 
        }
        .watermark { 
            display: block; 
            font-size: 9px; 
            margin-top: 8px; 
            opacity: 0.6; 
            font-weight: 900; 
            letter-spacing: 0.5px;
        }

        /* GENERATED IMAGES */
        .gen-img { 
            width: 100%; height: auto; 
            border-radius: 12px; 
            margin-top: 10px; 
            border: 1px solid var(--border);
            display: block;
        }
        .save-btn {
            background: #111; color: #fff;
            border: 1px solid #333;
            padding: 8px 15px; width: 100%;
            margin-top: 8px; border-radius: 8px;
            font-size: 12px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        /* --- CONTROLS AREA --- */
        .controls { 
            padding: 10px 15px 25px; 
            background: #050505; 
            border-top: 1px solid var(--border); 
            position: relative; 
            z-index: 500;
        }

        /* MODES */
        .modes { display: flex; gap: 8px; justify-content: center; margin-bottom: 12px; }
        .mode-btn { 
            background: #111; border: 1px solid #222; 
            color: #666; padding: 6px 14px; 
            border-radius: 20px; font-size: 10px; font-weight: 700; cursor: pointer; 
            transition: 0.2s;
        }
        .mode-btn.active { 
            border-color: var(--blue); color: var(--blue); 
            background: rgba(0,210,255,0.05); 
        }

        /* PLUS MENU (Mimics Yours) */
        #media-menu { 
            position: absolute; 
            bottom: 90px; left: 15px; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 16px; 
            display: none; 
            flex-direction: column; 
            width: 200px; 
            box-shadow: 0 10px 40px #000;
            overflow: hidden;
            z-index: 1000;
        }
        .menu-item { 
            padding: 14px; 
            display: flex; align-items: center; gap: 12px; 
            font-size: 14px; color: #eee; 
            border-bottom: 1px solid #222; 
            cursor: pointer;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #333; }

        /* INPUT BAR */
        .bar { 
            display: flex; gap: 10px; align-items: center; 
            background: #111; padding: 6px 10px 6px 16px; 
            border-radius: 30px; border: 1px solid #222; 
        }
        textarea { 
            flex: 1; background: transparent; border: none; 
            color: #fff; outline: none; resize: none; 
            font-size: 16px; padding: 8px 0; max-height: 100px;
        }
        .send-btn { 
            background: var(--blue); border: none; 
            width: 38px; height: 38px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: #000;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b style="color:var(--blue); font-size:18px;">History</b>
            <i data-lucide="x" onclick="toggleSidebar()" style="cursor:pointer; color:#666;"></i>
        </div>
        
        <button class="new-chat-btn" onclick="newChat()">
            <i data-lucide="plus" style="width:18px;"></i> New Chat
        </button>
        
        <div id="hist-list" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="app">
        <div id="header">
            <i data-lucide="menu" onclick="toggleSidebar()" style="color:var(--blue); cursor:pointer;"></i>
            <div style="font-weight:900; color:var(--blue); letter-spacing:1px; font-size:16px;">ARESE v2.5</div>
            <div style="width:24px;"></div> </div>

        <div id="chat-flow"></div>

        <div class="controls">
            
            <div id="media-menu">
                <div class="menu-item" onclick="alert('Camera Active')"><i data-lucide="camera" style="color:#ff5555;"></i> Camera</div>
                <div class="menu-item" onclick="alert('Photos')"><i data-lucide="image" style="color:#55ff55;"></i> Photos</div>
                <div class="menu-item" onclick="alert('Videos')"><i data-lucide="video" style="color:#5555ff;"></i> Videos</div>
                <div class="menu-item" onclick="alert('Audio')"><i data-lucide="mic" style="color:#ffff55;"></i> Audio</div>
                <div class="menu-item" onclick="alert('Docs')"><i data-lucide="file-text" style="color:#ff55ff;"></i> Documents</div>
            </div>

            <div class="modes">
                <button id="m-fast" class="mode-btn active" onclick="setMode('fast')">FAST</button>
                <button id="m-think" class="mode-btn" onclick="setMode('think')">THINK</button>
                <button id="m-pro" class="mode-btn" onclick="setMode('pro')">PRO</button>
            </div>

            <div class="bar">
                <i data-lucide="plus" onclick="toggleMenu()" style="color:#888; cursor:pointer; width:22px; height:22px;"></i>
                <textarea id="user-input" placeholder="Message Arese..." rows="1"></textarea>
                <button class="send-btn" onclick="execute()"><i data-lucide="arrow-up" style="width:20px;"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- KEYS ---
        const GROQ_KEY = "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";
        const FAL_KEY = "497d8139-336b-41b2-8a78-b23942a0ac51:fab2c66eee54d8b7f35e572984b75d75";
        
        let currentMode = 'fast';

        // --- INIT ---
        window.onload = () => { 
            lucide.createIcons(); 
            loadHistory(); 
            newChat(); 
        };

        // --- UI TOGGLES ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function toggleMenu() { 
            const m = document.getElementById('media-menu');
            m.style.display = (m.style.display === "flex") ? "none" : "flex"; 
        }
        function setMode(m) {
            currentMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('m-'+m).classList.add('active');
        }

        // --- MAIN EXECUTION ---
        async function execute() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if(!val) return;

            // 1. User Message
            appendMsg(val, 'user');
            input.value = "";
            document.getElementById('media-menu').style.display = "none"; // Close menu if open

            // 2. Setup AI Response
            const aiId = "ai-" + Date.now();
            const ringId = "ring-" + Date.now();
            
            // Show Thinking Bubble
            appendMsg(`<span id="${aiId}">...</span>`, 'ai', ringId);
            document.getElementById(ringId).style.display = 'block'; // START SPINNING

            // 3. Check for Image vs Text
            if(val.toLowerCase().startsWith("draw") || val.toLowerCase().startsWith("generate")) {
                await generateImage(val, aiId, ringId);
            } else {
                await generateText(val, aiId, ringId);
            }
            
            saveHistory(val);
        }

        // --- IMAGE ENGINE (Fal.ai) ---
        async function generateImage(prompt, aiId, ringId) {
            try {
                const res = await fetch("https://fal.run/fal-ai/flux/schnell", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Key ${FAL_KEY}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        image_size: "square_hd",
                        enable_safety_checker: false
                    })
                });
                
                const data = await res.json();
                const url = data.images[0].url;

                // Stop Loading
                document.getElementById(ringId).style.display = 'none'; 
                
                // Render Image with Save Button
                const container = document.getElementById(aiId);
                container.innerHTML = `
                    <div style="font-size:13px; margin-bottom:5px;">Generating: "${prompt}"</div>
                    <img src="${url}" class="gen-img" onclick="window.open('${url}')">
                    <button class="save-btn" onclick="window.open('${url}')"><i data-lucide="download" style="width:14px;"></i> SAVE IMAGE</button>
                `;
                lucide.createIcons();
            } catch (e) {
                console.error(e);
                document.getElementById(ringId).style.display = 'none';
                document.getElementById(aiId).innerText = "Vision Engine Error. Try again.";
            }
        }

        // --- TEXT ENGINE (Groq) ---
        async function generateText(prompt, aiId, ringId) {
            try {
                const model = currentMode === 'pro' ? "llama-3.3-70b-versatile" : "llama-3.1-8b-instant";
                
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${GROQ_KEY}`, 
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify({ 
                        model: model, 
                        messages: [{role: "user", content: prompt}] 
                    })
                });
                
                const data = await res.json();
                const reply = data.choices[0].message.content;

                // Stop Loading & Type Response
                document.getElementById(ringId).style.display = 'none';
                document.getElementById(aiId).innerText = "";
                new Typed(`#${aiId}`, { 
                    strings: [reply], 
                    typeSpeed: 15, 
                    showCursor: false 
                });

            } catch (e) {
                document.getElementById(ringId).style.display = 'none';
                document.getElementById(aiId).innerText = "Connection lost.";
            }
        }

        // --- MESSAGE RENDERER ---
        function appendMsg(content, type, ringId = "") {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `msg-container ${type}-side`;
            
            if(type === 'ai') {
                div.innerHTML = `
                    <div class="ai-avatar">
                        <div class="ring" id="${ringId}"></div>
                        <img src="https://i.ibb.co/vzY8M7m/arese-logo.png" class="msg-logo">
                    </div>
                    <div class="msg ai">
                        ${content}
                        <span class="watermark">Arese OS âœ“</span>
                    </div>
                `;
            } else {
                div.innerHTML = `<div class="msg user">${content}</div>`;
            }
            
            flow.appendChild(div);
            // Auto scroll
            setTimeout(() => flow.scrollTop = flow.scrollHeight, 100);
        }

        // --- HISTORY SYSTEM ---
        function saveHistory(text) {
            let h = JSON.parse(localStorage.getItem('arese_v2_hist') || "[]");
            h.unshift(text);
            localStorage.setItem('arese_v2_hist', JSON.stringify(h.slice(0, 15)));
            loadHistory();
        }

        function loadHistory() {
            const list = document.getElementById('hist-list');
            list.innerHTML = "";
            let h = JSON.parse(localStorage.getItem('arese_v2_hist') || "[]");
            
            if(h.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:20px; color:#444; font-size:12px;'>No history yet.</div>";
                return;
            }

            h.forEach((text, i) => {
                const item = document.createElement('div');
                item.className = "hist-item";
                item.innerHTML = `
                    <span onclick="restore('${text}')" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${text}</span>
                    <i data-lucide="trash-2" style="width:14px; color:#ff4444;" onclick="deleteH(event, ${i})"></i>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function deleteH(e, index) {
            e.stopPropagation();
            let h = JSON.parse(localStorage.getItem('arese_v2_hist') || "[]");
            h.splice(index, 1);
            localStorage.setItem('arese_v2_hist', JSON.stringify(h));
            loadHistory();
        }

        function restore(text) {
            toggleSidebar();
            document.getElementById('user-input').value = text;
        }

        function newChat() {
            document.getElementById('chat-flow').innerHTML = "";
            appendMsg("Arese OS v2.5 Online.<br>Ready to think, draw, or chat. ðŸ¦¾ðŸ¥€ðŸ”’", "ai", "init-ring");
            if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }
    </script>
</body>
</html>
