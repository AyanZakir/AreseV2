<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arese OS v2.5</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
    <style>
        :root { --blue: #00d2ff; --bg: #0b0b0b; --glass: rgba(0, 210, 255, 0.1); --border: #1f1f1f; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { height: 100dvh; width: 100vw; margin: 0; background: var(--bg); color: #fff; overflow: hidden; display: flex; }

        /* SCROLLBAR */
        #chat-flow::-webkit-scrollbar { width: 5px; }
        #chat-flow::-webkit-scrollbar-thumb { background: var(--blue); border-radius: 10px; }

        /* SIDEBAR */
        #sidebar { width: 280px; background: #080808; border-right: 1px solid var(--border); position: fixed; left: -280px; top: 0; bottom: 0; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; display: flex; flex-direction: column; padding: 20px; }
        #sidebar.open { left: 0; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
        #sidebar-overlay.show { display: block; }

        .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .new-chat-btn { background: var(--glass); border: 1px solid var(--blue); color: var(--blue); padding: 12px; border-radius: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .history-list { flex: 1; overflow-y: auto; margin-top: 20px; }
        .history-item { padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 14px; color: #aaa; transition: 0.2s; border: 1px solid transparent; }
        .history-item:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: #333; }

        /* MAIN CONTENT */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }

        /* NAVBAR */
        nav { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: rgba(11,11,11,0.8); backdrop-filter: blur(10px); z-index: 100; }
        .logo { font-size: 18px; font-weight: 800; letter-spacing: 2px; color: var(--blue); display: flex; align-items: center; gap: 10px; }

        /* CHAT AREA */
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; }
        .msg { max-width: 85%; padding: 15px; border-radius: 15px; font-size: 15px; line-height: 1.6; position: relative; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .user { align-self: flex-end; background: var(--blue); color: #000; font-weight: 500; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: var(--glass); border: 1px solid var(--border); border-bottom-left-radius: 2px; }

        .media-content { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border); }

        /* INPUT AREA */
        #input-container { position: absolute; bottom: 0; width: 100%; padding: 20px; background: linear-gradient(transparent, var(--bg) 40%); }
        .input-wrapper { background: #161616; border: 1px solid var(--border); border-radius: 20px; display: flex; align-items: center; padding: 5px 15px; transition: 0.3s; }
        .input-wrapper:focus-within { border-color: var(--blue); box-shadow: 0 0 15px rgba(0,210,255,0.1); }
        input { flex: 1; background: transparent; border: none; color: #fff; padding: 12px; font-size: 15px; }
        .send-btn { background: var(--blue); color: #000; border: none; width: 38px; height: 38px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .send-btn:active { transform: scale(0.9); }

        /* MODE SELECTOR */
        .mode-chips { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .mode-chips::-webkit-scrollbar { display: none; }
        .chip { padding: 6px 15px; border-radius: 20px; background: #1a1a1a; border: 1px solid var(--border); font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .chip.active { background: var(--blue); color: #000; border-color: var(--blue); }

        /* LOADING RING */
        .ring { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* TYPING EFFECT FIX */
        .typed-cursor { color: var(--blue); font-size: 18px; }
    </style>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="logo"><i data-lucide="shield"></i> ARCHIVE</div>
            <i data-lucide="x" onclick="toggleSidebar()" style="cursor:pointer"></i>
        </div>
        <button class="new-chat-btn" onclick="startNewSession()">
            <i data-lucide="plus"></i> NEW SPRINT
        </button>
        <div id="history-list" class="history-list"></div>
    </div>

    <div id="main">
        <nav>
            <i data-lucide="menu" onclick="toggleSidebar()" style="cursor:pointer"></i>
            <div class="logo">ARESE <span style="color:#fff">2.5</span></div>
            <i data-lucide="cpu" style="color:var(--blue)"></i>
        </nav>

        <div id="chat-flow"></div>

        <div id="input-container">
            <div class="mode-chips">
                <div class="chip active" onclick="setMode('Fast', this)">FAST</div>
                <div class="chip" onclick="setMode('Think', this)">THINK</div>
                <div class="chip" onclick="setMode('Pro', this)">PRO</div>
            </div>
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Enter command..." onkeypress="handleKey(event)">
                <div id="main-ring" class="ring" style="margin-right:10px"></div>
                <button class="send-btn" onclick="sendMessage()">
                    <i data-lucide="send" style="width:18px"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // UPDATED API CONFIGURATION (VERSION 1.4)
        const GOOGLE_API_KEY = "AIzaSyAlFcozmcW000eu091Xr3q_m4iwytUdWvw";
        
        let currentMode = 'Fast';
        let isProcessing = false;
        let chatHistory = [];
        let typedInstance = null;
        let abortController = null;

        lucide.createIcons();

        function setMode(mode, el) {
            currentMode = mode;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('show');
            if(document.getElementById('sidebar').classList.contains('open')) refreshHistory();
        }

        function handleKey(e) { if(e.key === 'Enter') sendMessage(); }

        function setProcessing(state) {
            isProcessing = state;
            document.getElementById('main-ring').style.display = state ? 'block' : 'none';
            document.getElementById('user-input').disabled = state;
        }

        function appendMsg(content, role, ringId = null) {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            
            const id = 'msg-' + Math.random().toString(36).substr(2, 9);
            div.innerHTML = `<div id="${id}">${content}</div>`;
            
            if(ringId) {
                const ring = document.createElement('div');
                ring.id = ringId;
                ring.className = 'ring';
                ring.style.display = 'block';
                ring.style.marginTop = '10px';
                div.appendChild(ring);
            }

            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;
            return { id, ringId };
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text || isProcessing) return;

            input.value = "";
            appendMsg(text, 'user');
            
            const aiMsg = appendMsg("", 'ai', 'ring-' + Date.now());
            setProcessing(true);

            await runChat(text, aiMsg.id, aiMsg.ringId);
        }

        // UPGRADED CHAT BRAIN & IMAGE ENGINE
        async function runChat(prompt, id, ring) {
            abortController = new AbortController();
            
            // Mode Mapping
            let modelId = "gemini-3-flash-preview"; // FAST
            if (currentMode === 'Think') modelId = "gemini-3-pro-preview"; // THINK
            if (currentMode === 'Pro') modelId = "gemini-2.5-flash-image"; // NANO BANANA

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${GOOGLE_API_KEY}`;

            try {
                const response = await fetch(url, {
                    method: "POST",
                    signal: abortController.signal,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "contents": [{ "parts": [{ "text": prompt }] }],
                        // Enable Thinking Process for THINK mode
                        "generationConfig": (currentMode === 'Think') ? { "thinking_level": "medium" } : {}
                    })
                });

                const data = await response.json();
                document.getElementById(ring).style.display = "none";

                // HANDLE NANO BANANA IMAGE OUTPUT
                if (currentMode === 'Pro') {
                    if (data.candidates && data.candidates[0].content.parts[0].inlineData) {
                        const b64Data = data.candidates[0].content.parts[0].inlineData.data;
                        const imgHtml = `<img src="data:image/png;base64,${b64Data}" class="media-content">`;
                        document.getElementById(id).innerHTML = imgHtml;
                    } else {
                        document.getElementById(id).innerText = "Image could not be generated. Try a different prompt.";
                    }
                    setProcessing(false);
                    return;
                }

                // HANDLE CHAT OUTPUT (FAST/THINK)
                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById(id).innerHTML = "";
                
                typedInstance = new Typed(`#${id}`, {
                    strings: [reply],
                    typeSpeed: 10,
                    showCursor: false,
                    onComplete: () => {
                        setProcessing(false);
                        saveChat();
                    }
                });

                chatHistory.push({role: "user", content: prompt}, {role: "assistant", content: reply});

            } catch (e) {
                if (e.name !== 'AbortError') {
                    document.getElementById(ring).style.display = "none";
                    document.getElementById(id).innerText = "Core Connection Error. Check your connection or API status. üõ†Ô∏è";
                    setProcessing(false);
                }
            }
        }

        function saveChat() {
            if(chatHistory.length < 2) return;
            let logs = JSON.parse(localStorage.getItem('arese_logs') || "[]");
            const title = chatHistory[0].content.substring(0, 25);
            const exists = logs.findIndex(l => l.title === title);
            
            if(exists > -1) logs[exists].data = chatHistory;
            else logs.unshift({ title, data: chatHistory });
            
            localStorage.setItem('arese_logs', JSON.stringify(logs.slice(0, 20)));
        }

        function refreshHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            let logs = JSON.parse(localStorage.getItem('arese_logs') || "[]");
            logs.forEach((log, i) => {
                const d = document.createElement('div');
                d.className = "history-item";
                d.innerHTML = `<span onclick="loadChat(${i})">${log.title}...</span><i data-lucide="trash-2" onclick="delChat(${i})" style="width:14px;"></i>`;
                list.appendChild(d);
            });
            lucide.createIcons();
        }

        function loadChat(i) {
            let logs = JSON.parse(localStorage.getItem('arese_logs') || "[]");
            chatHistory = logs[i].data;
            document.getElementById('chat-flow').innerHTML = "";
            chatHistory.forEach(m => appendMsg(m.content, m.role === 'user' ? 'user' : 'ai'));
            toggleSidebar();
        }

        function delChat(i) {
            let logs = JSON.parse(localStorage.getItem('arese_logs') || "[]");
            logs.splice(i, 1);
            localStorage.setItem('arese_logs', JSON.stringify(logs));
            refreshHistory();
        }

        function startNewSession() {
            chatHistory = [];
            document.getElementById('chat-flow').innerHTML = "";
            appendMsg("Arese OS v2.5 Online. All systems green. ü¶æü•Äüîí", "ai", "init-ring");
            setTimeout(() => document.getElementById('init-ring').style.display='none', 1000);
            if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }

        window.onload = startNewSession;
    </script>
</body>
</html>
