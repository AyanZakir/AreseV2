<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arese Vision v2.0</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --bg: #050505; --card: #111; --border: #1f1f1f; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid var(--border); }
        .back-btn { color: var(--blue); background: rgba(0,210,255,0.1); border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; text-decoration: none; font-size: 12px; }

        #viewport { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; padding: 20px; }
        #image-container { position: relative; width: 100%; max-width: 500px; border-radius: 15px; overflow: hidden; display: none; border: 1px solid var(--border); box-shadow: 0 0 40px rgba(0,210,255,0.05); }
        #output-img { width: 100%; height: auto; display: block; }
        .watermark { position: absolute; bottom: 10px; right: 10px; font-size: 10px; color: rgba(255,255,255,0.2); font-weight: 900; letter-spacing: 1px; pointer-events: none; }

        #loader { display: none; flex-direction: column; align-items: center; gap: 15px; }
        .ring { width: 45px; height: 45px; border: 3px solid #111; border-top: 3px solid var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .mode-container { display: flex; gap: 10px; padding: 15px; background: #000; border-top: 1px solid var(--border); }
        .mode-card { flex: 1; padding: 12px 5px; background: #0a0a0a; border: 1px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
        .mode-card.active { border-color: var(--blue); background: rgba(0,210,255,0.05); }
        .mode-card.disabled { opacity: 0.4; pointer-events: none; }
        .mode-card b { display: block; font-size: 11px; color: #fff; margin-bottom: 2px; }
        .mode-card span { font-size: 8px; color: #555; font-weight: 800; }

        .input-zone { padding: 0 15px 30px; background: #000; }
        .search-bar { background: #111; padding: 10px 14px; border-radius: 14px; border: 1px solid #222; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
        input { flex: 1; background: transparent; border: none; color: #fff; font-size: 14px; }
        
        /* THE PLUS BUTTON & PREVIEW */
        .plus-btn { color: var(--blue); cursor: pointer; display: flex; align-items: center; }
        #img-preview { width: 30px; height: 30px; border-radius: 6px; object-fit: cover; display: none; border: 1px solid var(--blue); }

        .btn-row { display: flex; gap: 10px; }
        .visual-btn { flex: 2; padding: 16px; background: var(--blue); color: #000; border: none; border-radius: 14px; font-weight: 900; text-transform: uppercase; cursor: pointer; }
        .visual-btn.stop { background: var(--red); color: #fff; }
        .icon-btn { flex: 0.5; background: #111; border: 1px solid #222; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="back-btn"><i data-lucide="arrow-left" style="width:16px;"></i> EXIT</a>
        <div style="font-size:10px; color:#444; font-weight:900; letter-spacing:2px;">CORE v2.0 [STABLE]</div>
        <div style="width:70px;"></div>
    </header>

    <div id="viewport">
        <div id="loader">
            <div class="ring"></div>
            <div id="status-text" style="font-size: 10px; color: var(--blue);">ENGAGING...</div>
        </div>
        <div id="image-container">
            <img id="output-img" src="">
            <div class="watermark">ARESE OS</div>
        </div>
    </div>

    <div class="mode-container" id="mode-list">
        <div class="mode-card active" id="m-fast" onclick="setMode('Fast')"><b>FAST</b><span>TURBO</span></div>
        <div class="mode-card" id="m-think" onclick="setMode('Think')"><b>THINK</b><span>HD</span></div>
        <div class="mode-card" id="m-pro" onclick="setMode('Pro')"><b>PRO</b><span>FLUX</span></div>
    </div>

    <div class="input-zone">
        <div class="search-bar">
            <img id="img-preview" src="">
            <input type="text" id="prompt-input" placeholder="Enter command...">
            <label class="plus-btn" for="img-upload">
                <i data-lucide="plus"></i>
            </label>
            <input type="file" id="img-upload" accept="image/*" style="display:none;" onchange="previewImage(this)">
        </div>
        <div class="btn-row">
            <button class="visual-btn" id="gen-btn" onclick="handleAction()">Visualize</button>
            <button class="icon-btn" onclick="downloadImg()"><i data-lucide="download" style="width:18px;"></i></button>
            <button class="icon-btn" onclick="shareImg()"><i data-lucide="share-2" style="width:18px;"></i></button>
        </div>
    </div>

    <script>
        const POLLY_KEY = "sk_7txPCoqzsFzn33j5zL9vFvhBeNISPnJL";
        let currentMode = 'Fast';
        let isGenerating = false;
        let abortController = null;
        let attachedImage = null;

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedImage = e.target.result;
                    const prev = document.getElementById('img-preview');
                    prev.src = attachedImage;
                    prev.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setMode(m) {
            if(isGenerating) return;
            currentMode = m;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`m-${m.toLowerCase()}`).classList.add('active');
        }

        function handleAction() {
            if(isGenerating) stopGeneration();
            else startGeneration();
        }

        async function startGeneration() {
            const prompt = document.getElementById('prompt-input').value.trim();
            if(!prompt) return;

            isGenerating = true;
            abortController = new AbortController();
            updateUI(true);

            const status = document.getElementById('status-text');
            status.innerText = attachedImage ? "EDITING IMAGE..." : `GENERATING ${currentMode.toUpperCase()}...`;

            try {
                const seed = Math.floor(Math.random() * 999999);
                // If an image is attached, we append it to the prompt logic for Pollinations to "read"
                let finalPrompt = prompt;
                if(attachedImage) finalPrompt = `Ref image: ${attachedImage} | Task: ${prompt}`;

                const url = `https://pollinations.ai/p/${encodeURIComponent(finalPrompt)}?width=1024&height=1024&seed=${seed}&model=turbo&nologo=true`;

                const response = await fetch(url, { signal: abortController.signal });
                if (!response.ok) throw new Error("Busy");

                const blob = await response.blob();
                document.getElementById('output-img').src = URL.createObjectURL(blob);
                document.getElementById('loader').style.display = "none";
                document.getElementById('image-container').style.display = "block";
                updateUI(false);
            } catch (e) {
                if(e.name !== 'AbortError') {
                    status.innerText = "RETRIEVING...";
                    setTimeout(startGeneration, 2000);
                }
            }
        }

        function stopGeneration() {
            if(abortController) abortController.abort();
            updateUI(false);
        }

        function updateUI(generating) {
            const btn = document.getElementById('gen-btn');
            btn.innerText = generating ? "STOP" : "VISUALIZE";
            btn.classList.toggle('stop', generating);
            document.getElementById('mode-list').querySelectorAll('.mode-card').forEach(c => c.classList.toggle('disabled', generating));
            if(generating) {
                document.getElementById('loader').style.display = "flex";
                document.getElementById('image-container').style.display = "none";
            }
        }

        function downloadImg() {
            const a = document.createElement('a'); a.href = document.getElementById('output-img').src; a.download = 'arese.png'; a.click();
        }

        async function shareImg() {
            const res = await fetch(document.getElementById('output-img').src);
            const blob = await res.blob();
            const file = new File([blob], 'vision.png', { type: 'image/png' });
            navigator.share({ files: [file] });
        }

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
